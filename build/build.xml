<?xml version="1.0"?>
<!-- ====================================================================== 
Build a new distribution of Ortus CommandBox:
This build downloads required libs depending on the target.

External Dependencies:
- lucee-cli
- launch4j
====================================================================== -->
<project name="distro.build" default="build.cli" basedir="./" xmlns:antcontrib="antlib:net.sf.antcontrib">
	 <description>
    	Build a new distribution of Ortus CommandBox
    </description>

    <!-- Version: UPDATE ON EACH RELEASE AS NEEDED -->
 	<property name="distro.groupID"				value="ortussolutions" />
 	<property name="distro.name"				value="commandbox"/>
 	<property name="commandbox.version"			value="2.2.0"/>
 	<property name="commandbox.stableVersion"	value="2.2.0"/>

    <!-- Time Label -->
	<tstamp prefix="start"/>
	<!-- Load build lib tasks -->
	<path id="build.antcontrib.libpath">
		<fileset dir="${basedir}/lib">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<!-- Define Tasks -->
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="build.antcontrib.libpath" />
	<!-- Import Box-Repo Tasks -->
	<import><url url="https://raw.githubusercontent.com/Ortus-Solutions/box-tasks/master/box-repo.xml"/></import>
	
	<!-- Default environment check, if not passed via -Denvironment -->
	<condition property="environment" value="local">
		<not><isset property="environment" /></not>
	</condition>
	<if>
		<available file="build-${environment}.properties" />
		<then>
			<!-- Load env properties -->
			<echo>Loading properties from environment: ${environment}</echo>
			<loadproperties srcFile="build-${environment}.properties"/>
		</then>
	</if>
	<!-- Load root properties -->
	<echo>Loading base properties</echo>
	<loadproperties srcFile="build.properties"/>

	<!-- import cfdistro -->
	<import file="${cfdistro.build.file}"/>
	<property name="maven.repo.local" value="${cfdistro.basedir}/artifacts"/>
	
	<!-- Init Build -->
	<target name="init" description="Init build" unless="src.isInit">
		<!-- cleanup -->
		<delete dir="${temp.dir}" />
		<delete dir="${build.dir}" />
		<delete dir="${lib.dir}"/>
		<delete dir="${dist.dir}"/>

		<!-- init dirs -->
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${build.dir}"/>
		<chmod file="${build.dir}/**" perm="g+wxrs" type="both" />

		<!-- Increment Build Number -->
		<propertyfile file="build.number" comment="Build Number for ANT. Edit not!">
			<entry key="build.number" 
					type="int" 
			     	operation="+"
					pattern="00000"
			     	default="1" />
		</propertyfile>
		<!-- Retrieve Build Number -->
		<property file="build.number"/>

		<!-- Create version file -->
		<echo file="${build.dir}/.version" append="false">${commandbox.version}+${build.number}</echo>
		
		<!-- If stg, change perms and owners -->
		<antcall target="update.permissions" />

		<!-- get commandbox dependencies 
		<dependency groupId="jline" artifactId="jline" version="2.12" dest="${lib.dir}" type="jar" unzip="false"/>
		<dependency groupId="org.lucee" artifactId="lucee.cli" version="${cfml.cli.version}" dest="${temp.dir}/rcli" type="jar" unzip="true"/>
		-->
		
		<!-- Mark as init -->
		<property name="src.isInit" value="true" />
	</target>

	<!-- update permissions on reports -->
	<target name="update.permissions" description="Update staging server permissions">
		<!-- Integration permissions -->
		<if>
			<equals arg1="${environment}" arg2="auto" />
			<then>
				<chmod file="${temp.dir}/**" perm="go+wrs" type="both" verbose="true" />
				<chown owner="stg-ortus" verbose="true">
					<fileset dir="${temp.dir}" />
				</chown>
			</then>
			<else>
			</else>
		</if>
	</target>

	<!-- Build everything -->
	<target name="build.cli.all" depends="build.cli.deb,build.cli.exe,build.cli.jre,build.cli.rpm,build.apidocs,build.homebrew">
		<antcontrib:if>
			<equals arg1="${build.type}" arg2="auto" />
			<then>
				<!-- Remove Unecessary build files from repo, so to not confuse -->
				<delete>
					<fileset file="${dist.dir}/box" />
					<fileset file="${dist.dir}/box.exe" />
				</delete>
				<!-- BE API Docs -->
				<unzip src="${dist.dir}/${distro.name}-apidocs-${commandbox.version}.zip" dest="${artifact.dir}/be-apidocs" overwrite="true"/>
			</then>
		</antcontrib:if>
	</target>

	<!-- Build CLI -->
	<target name="build.cli" description="builds box.jar" depends="init,resolve.libs">
		
		<!-- Prepare Compile Path -->
		<path id="classpath">
			<fileset dir="${lucee.lib.dir}"/>
			<fileset dir="${lib.dir}"/>
		</path>
		
		<!-- Compile java source -->
		<mkdir dir="${temp.dir}/cli/bin" />
		<javac srcdir="${src.dir}/java" 
			   destdir="${temp.dir}/cli/bin" 
			   source="${java.compiler}"
			   target="${java.compiler}" 
			   classpath="${toString:classpath}"
			   debug="${java.debug}" />
		
		<!-- Copy libs to engine destination -->
		<copy todir="${lucee.lib.dir}">
	      <fileset dir="${lib.dir}" includes="*.jar" />
	    </copy>
		<mkdir dir="${temp.dir}/engine" />
		
		<!-- Configure Lucee Web Dir -->
		<configure-lucee-web 
		      config-server="${temp.dir}/engine/cfml/cli/cfml-server/context/lucee-server.xml"
		      config-web="${temp.dir}/engine/cfml/cli/cfml-web/lucee-web.xml.cfm"
		      dump-cfc="${temp.dir}/engine/cfml/cli/cfml-server/context/library/tag/Dump.cfc"/>
		<antcontrib:var name="lucee.config.file" value="${temp.dir}/engine/cfml/cli/cfml-web/lucee-web.xml.cfm" />
		
		<!-- update lucee password -->
		<lucee-password 
	      server-password="commandbox" config-server-file="${temp.dir}/engine/cfml/cli/cfml-server/context/lucee-server.xml"
	      web-password="commandbox" config-web-file="${temp.dir}/engine/cfml/cli/cfml-web/lucee-web.xml.cfm"
	    />
		
		<!-- update lucee error template path -->
		<!-- Copy Error Template From Our Resources -->
		<copy file="${src.dir}/resources/error-cli.cfm" todir="${temp.dir}/engine/cfml/cli/cfml-web/context/templates/error/" encoding="UTF-8"/>
		<lucee-error-template path="/lucee/templates/error/error-cli.cfm" 
	      configfile="${temp.dir}/engine/cfml/cli/cfml-web/lucee-web.xml.cfm" />

		<!-- Copy Resources to build cli bin -->
        <copy todir="${temp.dir}/cli/bin/resource" encoding="UTF-8">
        	<fileset dir="${src.dir}/resources"/>
    	</copy>
    	<copy file="${src.dir}/java/cliloader/cli.properties" todir="${temp.dir}/cli/bin/cliloader" />
		<copy todir="${temp.dir}/cli/bin/cliloader" file="${src.dir}/java/cliloader/version.properties">
	      <filterchain><expandproperties/><deletecharacters chars="\n"/><trim/><ignoreblank/></filterchain>
	    </copy>
		
		<!-- Zip up the engine -->
		<zip destfile="${temp.dir}/cli/engine.zip">
	      <fileset dir="${temp.dir}/engine"/>
	    </zip>
		
		<!-- we put the loader into a jar and then into libs.zip for classloading reasons -->
		<jar destfile="${temp.dir}/cli/luceecli.jar" filesetmanifest="mergewithoutmain" level="9">
			<manifest>
				<attribute name="Main-Class" value="luceecli.CLIMain" />
			</manifest>
			<fileset dir="${temp.dir}/cli/bin">
				<exclude name="cliloader/" />
				<exclude name="com/" />
			</fileset>
		</jar>
		<delete dir="${temp.dir}/cli/bin/luceecli" />
		
		<!-- Custom Jgit libs -->
		<jar destfile="${temp.dir}/cli/ortus-jgit.jar" filesetmanifest="mergewithoutmain" level="9">
			<fileset dir="${temp.dir}/cli/bin">
				<exclude name="cliloader/" />
				<exclude name="resource/" />
			</fileset>
		</jar>
		<delete dir="${temp.dir}/cli/bin/com" />
	
		<!-- Copy CommandBox code -->
      	<copy todir="${build.dir}" encoding="UTF-8">
        	<fileset dir="${src.dir}/cfml"/>
        	<fileset file="../license.txt"/>
        	<fileset file="../readme.txt"/>
        </copy>
		<!-- Replace Version Numbers -->
		<replaceregexp match='@build.version@' replace="${commandbox.version}" flags="ig" byline="true" encoding="UTF-8">
		  <fileset dir="${build.dir}" />
		</replaceregexp>
		<!-- Replace Loader Version Numbers -->
		<replaceregexp match='@build.LoaderVersion@' replace="${cfml.loader.version}" flags="ig" byline="true" encoding="UTF-8">
		  <fileset dir="${build.dir}" />
		</replaceregexp>
		<!-- Replace Build Numbers -->
		<replaceregexp match='@build.number@' replace="${build.number}" flags="ig" byline="true" encoding="UTF-8">
		  <fileset dir="${build.dir}" />
		</replaceregexp>
		<!-- Create Version Files -->
		<echo file="${temp.dir}/cli/bin/cliloader/cfml.version" message="${commandbox.version}"/>

		<!--  create the cfml distro zip -->
		<zip destfile="${dist.dir}/${distro.name}-cfml-${commandbox.version}.zip" update="false" level="9">
	        <fileset dir="${build.dir}"/>
			<zipfileset file="${temp.dir}/version" fullpath="cli/version"/>
			<zipfileset file="${temp.dir}/cli/bin/cliloader/cfml.version" fullpath=".version"/>
		</zip>
		<copy file="${dist.dir}/${distro.name}-cfml-${commandbox.version}.zip" toFile="${temp.dir}/cli/cfml.zip" overwrite="true" />
			
		<!-- Build Checksum for cfml.zip -->
		<checksum file="${dist.dir}/${distro.name}-cfml-${commandbox.version}.zip" forceoverwrite="true" fileext=".md5" />
		<checksum file="${dist.dir}/${distro.name}-cfml-${commandbox.version}.zip" forceoverwrite="true" algorithm="sha" />
		
		<!--  create the libs zip including cli loader, optionally use pack200 -->
	    <antcontrib:if>
	      <equals arg1="${java.pack200}" arg2="true" />
	      <then>
	        <delete dir="${temp.dir}/packlibs" />
	        <mkdir dir="${temp.dir}/packlibs"/>
	        <mkdir dir="${temp.dir}/packlibs/packed"/>
	        <copy todir="${temp.dir}/packlibs">
	          <fileset dir="${lucee.lib.dir}">
	            <include name="**/*.jar"/>
	            <exclude name="**/lucee-loader.jar"/>
	            <exclude name="**/javax*servlet.jar"/>
	            <exclude name="**/org*mortbay*jetty.jar"/>
	          </fileset>
	          <fileset file="${temp.dir}/cli/luceecli.jar" />
	          <fileset file="${temp.dir}/cli/ortus-jgit.jar" />
	        </copy>
	        <packjars dir="${temp.dir}/packlibs" packdir="${temp.dir}/packlibs/packed" excludes="ESAPI*,microsoft-*"/>
	        <zip destfile="${temp.dir}/cli/libs.zip">
	          <fileset dir="${temp.dir}/packlibs/packed"/>
	        </zip>
	        <delete dir="${temp.dir}/packlibs" />
	      </then>
	      <else>
	        <zip destfile="${temp.dir}/cli/libs.zip">
	          <fileset dir="${lucee.lib.dir}">
	          <include name="**/*.jar"/>
	          <exclude name="**/lucee-loader.jar"/>
	          <exclude name="**/javax*servlet.jar"/>
	          <exclude name="**/org*mortbay*jetty.jar"/>
	          </fileset>
	          <fileset file="${temp.dir}/cli/luceecli.jar" />
	          <fileset file="${temp.dir}/cli/ortus-jgit.jar" />
	        </zip>
	      </else>
	    </antcontrib:if>
	    <delete file="${temp.dir}/cli/luceecli.jar" />
	    <delete file="${temp.dir}/cli/ortus-jgit.jar" />
		
		<echo file="${temp.dir}/version" message="${cfml.loader.version}" />
		
		<!-- Create jar -->
        <jar destfile="${dist.dir}/box.jar" filesetmanifest="mergewithoutmain" level="9">
			<manifest>
				<attribute name="Main-Class" value="cliloader.LoaderCLIMain" />
			</manifest>
	        <fileset file="${temp.dir}/cli/libs.zip" />
			<fileset file="${temp.dir}/cli/cfml.zip" />
        	<fileset file="${temp.dir}/cli/engine.zip" />
			<fileset dir="${temp.dir}/cli/bin" />
        	<zipfileset src="${lib.dir}/json-smart-mini-1.0.8.jar" includes="**/*.class" />
        	<fileset file="${temp.dir}/cli/version"/>
		</jar>

        <!-- Checksum on Jar -->
        <checksum file="${dist.dir}/box.jar" forceoverwrite="true" fileext=".md5" />
        <checksum file="${dist.dir}/box.jar" forceoverwrite="true" algorithm="sha" />

		<!-- Create box-repo.json -->
		<box-repo location="${artifact.dir}"
				  artifactID="${distro.name}" 
				  groupID="${distro.groupID}"
				  buildID="${build.number}"
				  latest="${commandbox.version}"
				  stableVersion="${commandbox.stableVersion}"
				  classifiers="cfml,bin,win,deb,rpm,apidocs"/>
		
		<!-- Create box-loader.json -->
		<concat destfile="${artifact.dir}/box-loader.json" overwrite="true">{
			"artifactID" : "commandbox-loader",
			"groupID" : "${distro.groupID}",
			"versioning" : {
				"latestVersion" : "${cfml.loader.version}",
				"latestBuildID" : "${build.number}",
				"latestUpdated" : "${repo.timestamp.DSTAMP}${repo.timestamp.TSTAMP}",
				"stableVersion" : "${cfml.loader.version}",
				"versions" : [],
				"classifiers" : ""
			}
		}</concat>

 	</target>

 	<!-- Build Homebrew Recipe -->
 	<target name="build.homebrew" description="Builds the Homebrew Recipe" depends="">
		
		<!-- Check sum properties -->
		<checksum file="${dist.dir}/${distro.name}-bin-${commandbox.version}.zip" property="commandbox.sha1" algorithm="SHA"/>
		<checksum file="${dist.dir}/${distro.name}-apidocs-${commandbox.version}.zip" property="commandbox.apidocs.sha1" algorithm="SHA"/>
		
		<!-- copy over prd file -->
		<copy file="brew-template.rb" 
			  tofile="${artifact.dir}/commandbox.rb"
			  overwrite="true"
			  encoding="UTF-8" />

		<replace file="${artifact.dir}/commandbox.rb" value="" summary="yes" encoding="UTF-8">
		  	<replacetoken>@be@</replacetoken>
		</replace>
		<replace file="${artifact.dir}/commandbox.rb" value="${commandbox.version}" summary="yes" encoding="UTF-8">
		  	<replacetoken>@version@</replacetoken>
		</replace>
		<replace file="${artifact.dir}/commandbox.rb" value="${ortus.repoPRDURL}" summary="yes" encoding="UTF-8">
		  	<replacetoken>@repoURL@</replacetoken>
		</replace>
		<replace file="${artifact.dir}/commandbox.rb" value="${commandbox.sha1}" summary="yes" encoding="UTF-8">
		  	<replacetoken>@sha1@</replacetoken>
		</replace>
		<replace file="${artifact.dir}/commandbox.rb" value="${commandbox.apidocs.sha1}" summary="yes" encoding="UTF-8">
		  	<replacetoken>@apidocs.sha1@</replacetoken>
		</replace>

		<!-- copy over be file -->
		<copy file="brew-template.rb" 
			  tofile="${artifact.dir}/commandbox-be.rb"
			  overwrite="true"
			  encoding="UTF-8" />

		<replace file="${artifact.dir}/commandbox-be.rb" value="Be" summary="yes" encoding="UTF-8">
		  	<replacetoken>@be@</replacetoken>
		</replace>
 		<replace file="${artifact.dir}/commandbox-be.rb" value="${commandbox.version}" summary="yes" encoding="UTF-8">
		  	<replacetoken>@version@</replacetoken>
		</replace>
		<replace file="${artifact.dir}/commandbox-be.rb" value="${ortus.repoURL}" summary="yes" encoding="UTF-8">
		  	<replacetoken>@repoURL@</replacetoken>
		</replace>
		<replace file="${artifact.dir}/commandbox-be.rb" value="${commandbox.sha1}" summary="yes" encoding="UTF-8">
		  	<replacetoken>@sha1@</replacetoken>
		</replace>
		<replace file="${artifact.dir}/commandbox-be.rb" value="${commandbox.apidocs.sha1}" summary="yes" encoding="UTF-8">
		  	<replacetoken>@apidocs.sha1@</replacetoken>
		</replace>

 	</target>

 	<!-- Build API Docs -->
 	<target name="build.apidocs" description="Builds the api docs" depends="build.cli.bin">
 		<!-- Create APIDocs dir -->
 		<mkdir dir="${temp.dir}/apidocs"/>
 		<!-- Install dependencies for docs -->
		<exec executable="${dist.dir}/box" dir="${dir.apidocs}">
			<arg line="install" />
		</exec>
		<!-- Startup the apidocs server, wait for a few seconds for server to start -->
		<exec executable="${dist.dir}/box" dir="${dir.apidocs}">
			<arg line="server start openbrowser=false --force port=${apidocs.port}" />
		</exec>
		<sleep seconds="5"/>
		<!-- Get the apidocs now -->
		<property name="temp.dir.absolute" location="${temp.dir}"/>
		<get dest="${temp.dir}/docbox.html" 
			 src="${url.apidocs}?version=${commandbox.version}&amp;path=${temp.dir.absolute}/apidocs" 
			 verbose="true"
			 retries="5"/>
		<delete file="${temp.dir}/docbox.html" />
 		<!-- stop server -->
		<exec executable="${dist.dir}/box" dir="${dir.apidocs}">
			<arg line="server stop" />
		</exec>
		<!-- Zip API Docs -->
		<zip destfile="${dist.dir}/${distro.name}-apidocs-${commandbox.version}.zip" basedir="${temp.dir}/apidocs"></zip>
 		<!-- Build Checksum -->
 		<checksum forceoverwrite="true" fileext=".md5" file="${dist.dir}/${distro.name}-apidocs-${commandbox.version}.zip" />
 		<checksum forceoverwrite="true" algorithm="sha" file="${dist.dir}/${distro.name}-apidocs-${commandbox.version}.zip" />
 	</target>

	<!-- Build linux/mac bin -->
	<target name="build.cli.bin" description="create linux/mac binary" depends="build.cli">
		<!--  this bundles the jar into the executable wrapper, which is a bash script -->
        <concat destfile="${dist.dir}/box" force="yes" binary="true">
          <fileset file="${src.dir}/bin/box.sh" />
          <fileset file="${dist.dir}/box.jar" />
        </concat>
        <!-- Change execute perm -->
        <chmod file="${dist.dir}/box" perm="a+x"/>
        <!-- Create distro zip -->
		<zip destfile="${dist.dir}/${distro.name}-bin-${commandbox.version}.zip" level="9" update="false">
	        <zipfileset file="${dist.dir}/box" filemode="711" prefix="" />
		</zip>
		<!-- Build Checksum -->
		<checksum file="${dist.dir}/${distro.name}-bin-${commandbox.version}.zip" forceoverwrite="true" fileext=".md5" />
		<checksum file="${dist.dir}/${distro.name}-bin-${commandbox.version}.zip" forceoverwrite="true" algorithm="sha" />
 	</target>

	<!-- Build windows executable -->
	<target name="build.cli.exe" description="create exe wrapper" depends="build.cli" >
        <!-- Get OS version of lanuch4j -->
        <antcall target="getlaunch4j" />
        <!-- Build Executable Now -->
        <taskdef name="launch4j" 
        		 classname="net.sf.launch4j.ant.Launch4jTask" 
        		 classpath="./launch4j/launch4j.jar:./launch4j/lib/xstream.jar" />
        <launch4j>
			<config headerType="console" 
					outfile="${dist.dir}/box.exe" 
					jarPath="${dist.dir}/box.jar" 
					errTitle="Error running CommandBox"
					supportURL="${commandbox.supportURL}"
					chdir="%OLDPWD%"
					icon="${src.dir}/resources/box.ico"
					stayAlive="true">
					<jre path="./jre/" minVersion="1.7.0" />
					<versionInfo fileVersion="${commandbox.version}.0"
								 txtFileVersion="${commandbox.version}.${build.number}"
								 fileDescription="${commandbox.description}"
								 copyright="Copyright since 2013 Ortus Solutions, Corp"
								 productVersion="${commandbox.version}.0"
								 txtProductVersion="${commandbox.version}.${build.number}"
								 productName="CommandBox"
								 companyName="Ortus Solutions, Corp"
								 internalName="CommandBox"
								 originalFilename="box.exe" />
			</config>
		</launch4j>
		
		<!-- Zip it -->
		<zip destfile="${dist.dir}/${distro.name}-win-${commandbox.version}.zip" level="9" update="false">
	        <zipfileset file="${dist.dir}/box.exe" prefix="" />
		</zip>
		<!-- Build Checksum -->
		<checksum file="${dist.dir}/${distro.name}-win-${commandbox.version}.zip" forceoverwrite="true" fileext=".md5" />
		<checksum file="${dist.dir}/${distro.name}-win-${commandbox.version}.zip" forceoverwrite="true" algorithm="sha" />
	</target>

	<!-- Build including JREs -->
 	<target name="build.cli.jre" description="Build with JRE included" depends="build.cli.bin,build.cli.exe">
 		<echo message="Bundling ${jre.version} JRE" />
		
		<!-- Get JRE Dependencies -->
		<dependency groupId="oracle" artifactId="jre" version="${jre.version}" type="zip" classifier="win32" />
		<dependency groupId="oracle" artifactId="jre" version="${jre.version}" type="zip" classifier="win64" />
		<dependency groupId="oracle" artifactId="jre" version="${jre.version}" type="zip" classifier="linux32" />
		<dependency groupId="oracle" artifactId="jre" version="${jre.version}" type="zip" classifier="linux64" />
		<dependency groupId="oracle" artifactId="jre" version="${jre.version}" type="zip" classifier="darwin64" />

		<!--Zip Box Binary With JRE -->
		<zip destfile="${dist.dir}/${distro.name}-jre-win32-${commandbox.version}.zip" level="9" update="false">
			<zipfileset prefix="jre" src="${maven.repo.local}/oracle/jre/${jre.version}/jre-${jre.version}-win32.zip"/>
	        <fileset file="${dist.dir}/box.exe" />
		</zip>
		<zip destfile="${dist.dir}/${distro.name}-jre-win64-${commandbox.version}.zip" level="9" update="false">
			<zipfileset prefix="jre" src="${maven.repo.local}/oracle/jre/${jre.version}/jre-${jre.version}-win64.zip"/>
	        <fileset file="${dist.dir}/box.exe" />
		</zip>
		<zip destfile="${dist.dir}/${distro.name}-jre-linux32-${commandbox.version}.zip" level="9" update="false">
			<zipfileset prefix="jre" src="${maven.repo.local}/oracle/jre/${jre.version}/jre-${jre.version}-linux32.zip"/>
      <zipfileset file="${dist.dir}/box" filemode="711" prefix="" />
		</zip>
		<zip destfile="${dist.dir}/${distro.name}-jre-linux64-${commandbox.version}.zip" level="9" update="false">
			<zipfileset prefix="jre" src="${maven.repo.local}/oracle/jre/${jre.version}/jre-${jre.version}-linux64.zip"/>
      <zipfileset file="${dist.dir}/box" filemode="711" prefix="" />
		</zip>
		<zip destfile="${dist.dir}/${distro.name}-jre-darwin64-${commandbox.version}.zip" level="9" update="false">
			<zipfileset prefix="jre" src="${maven.repo.local}/oracle/jre/${jre.version}/jre-${jre.version}-darwin64.zip"/>
      <zipfileset file="${dist.dir}/box" filemode="711" prefix="" />
		</zip>

		<!-- Build Checksum -->
		<checksum forceoverwrite="true" fileext=".md5">
			<fileset dir="${dist.dir}">
				<include name="*-jre-*.zip" />
			</fileset>
		</checksum>
		<checksum forceoverwrite="true" algorithm="sha">
			<fileset dir="${dist.dir}">
				<include name="*-jre-*.zip" />
			</fileset>
		</checksum>
 	</target>
	
	<!-- Build local maven repository build.cli.deb,build.cli.exe,build.cli.rpm-->
 	<target name="build.cli.mvn" depends="build.cli.deb,build.cli.exe,build.cli.jre,build.cli.rpm">
		<pom-and-deploy pomid="commandbox.pom" packaging="pom" buildtype="${mvn.type}"
			groupId="com.ortussolutions" artifactId="commandbox" version="${commandbox.version}"
			name="commandbox">
			<attachments>
				<attach file="${dist.dir}/box.jar" type="jar" />
				<attach file="${dist.dir}/${distro.name}-cfml-${commandbox.version}.zip" type="zip" classifier="cfml" />
				<attach file="${dist.dir}/${distro.name}-debian-${commandbox.version}.deb" type="deb" />
				<attach file="${dist.dir}/${distro.name}-bin-${commandbox.version}.zip" type="zip" classifier="bin" />
				<attach file="${dist.dir}/${distro.name}-jre-darwin64-${commandbox.version}.zip" type="zip" classifier="jre-darwin64" />
				<attach file="${dist.dir}/${distro.name}-jre-linux32-${commandbox.version}.zip" type="zip" classifier="jre-linux32" />
				<attach file="${dist.dir}/${distro.name}-jre-linux64-${commandbox.version}.zip" type="zip" classifier="jre-linux64" />
				<attach file="${dist.dir}/${distro.name}-jre-win32-${commandbox.version}.zip" type="zip" classifier="jre-win32" />
				<attach file="${dist.dir}/${distro.name}-jre-win64-${commandbox.version}.zip" type="zip" classifier="jre-win64" />
				<attach file="${dist.dir}/${distro.name}-win-${commandbox.version}.zip" type="zip" classifier="win32" />
				<attach file="${dist.dir}/${distro.name}-rpm-${commandbox.version}.rpm" type="rpm" />
			</attachments>
		</pom-and-deploy>
	</target>

  <target name="build.cli.deb" depends="build.cli.bin" description="builds a .deb file for debian-based systems ONLY!">
    <!-- Load deb task -->
    <loadproperties srcFile="/root/creds/secret.properties"/>
    <taskdef-dependency name="debtask" classname="debrepo.ant.DebTask" artifactId="debrepo" groupId="org.cfmlprojects" version="1.0.0" />
    <mkdir dir="${deb.repo}"/>
    <debtask
        todir="${deb.repo}"
        package="commandbox"
        section="web"
        depends="java-common"
        key="${ortus.sign.key.id}"
        passphrase="${ortus.sign.key.passphrase}"
        keyring="${ortus.sign.keyring}">
        <version upstream="${commandbox.version}"/>
        <maintainer name="${commandbox.packager.name}" email="${commandbox.packager.email}"/>
        <description synopsis="${commandbox.description}">CommandBox Version: ${commandbox.version}.</description>
      <tarfileset file="${dist.dir}/box" prefix="usr/local/bin" filemode="755"/>
    </debtask>
    <!-- Copy deb package to dist dir too -->
    <copy file="${deb.repo}/${distro.name}_${commandbox.version}-1_all.deb" toFile="${dist.dir}/${distro.name}-debian-${commandbox.version}.deb"/>
    <!-- Build Checksum -->
    <checksum file="${dist.dir}/${distro.name}-debian-${commandbox.version}.deb" forceoverwrite="true" fileext=".md5" />
    <checksum file="${dist.dir}/${distro.name}-debian-${commandbox.version}.deb" forceoverwrite="true" algorithm="sha" />
    <echo message="Updating apt (deb) repo in ${deb.repo}"/>
    <!-- Update Repo -->
    <deb-repo dir="${deb.repo}"
        label="ortus" description="ortussolutions.com debian repository"
        key="${ortus.sign.key.id}"
        passphrase="${ortus.sign.key.passphrase}"
        keyring="${ortus.sign.keyring}" />
  </target>

  <!-- Build RPM: Leverages redline task -->
  <target name="build.cli.rpm" depends="build.cli.bin">
    <mkdir dir="${rpm.repo}" />
    <echo message="Making rpm in ${rpm.repo} Packager:${commandbox.packager.name} ${commandbox.packager.email} Version: ${commandbox.version}" />
    <!-- execute rpm -->
    <property name="commandbox.rpm.repourl" value="${ortus.repoURL}/RPMS/noarch" />
    <echo message="RPM repository location: ${commandbox.rpm.repourl}"/>
    <rpm-create rpm.repo="${rpm.repo}" rpm.release="1"
      rpm.reponame="ortus" rpm.baseurl="${commandbox.rpm.repourl}"
      rpm.group="com.ortussolutions" rpm.name="${distro.name}" rpm.version="${commandbox.version}"
      rpm.packager="${commandbox.packager.name} ${commandbox.packager.email}"
      rpm.url="${commandbox.supportURL}" failonerror="false"
      rpm.keyring="${ortus.sign.keyring}" rpm.key="${ortus.sign.key.id}" 
      rpm.passphrase="${ortus.sign.key.passphrase}">
      <tarfileset file="${dist.dir}/box" prefix="/usr/bin" filemode="744" username="root" group="root"/>
    </rpm-create>
    <!-- Copy rpm to repo -->
    <copy file="${rpm.repo}/${distro.name}-${commandbox.version}-1.noarch.rpm" tofile="${dist.dir}/${distro.name}-rpm-${commandbox.version}.rpm" />
    <!-- Build Checksum -->
    <checksum file="${dist.dir}/${distro.name}-rpm-${commandbox.version}.rpm" forceoverwrite="true" fileext=".md5" />
  </target>
  
	<!-- ********************************************************************************************-->
	<!--						DEPENDENCY TARGETS 													 -->
	<!-- ********************************************************************************************-->
	
	<target name="resolve.libs">
		<delete dir="${lib.dir}"/>
 		<mvn-repo id="jgit-repository" url="https://repo.eclipse.org/content/groups/releases/" />
 		<!-- 
 		<mvn-repo id="jboss.repo" url="http://repository.jboss.org/nexus/content/repositories/releases" />
		
		<dependency groupId="org.jboss.aesh" artifactId="aesh" unzip="false" version="0.53" type="jar" dest="${lib.dir}" repoId="jboss.repo" />
		<dependency groupId="org.jboss.jreadline" artifactId="jreadline"
			unzip="false" version="0.20" type="jar" dest="${lib.dir}" repoId="jboss.repo">
			<exclusions>
				<exclusion groupId="org.fusesource.jansi" artifactId="jansi" />
			</exclusions>
		</dependency>
		<dependency groupId="org.fusesource.jansi" artifactId="jansi" unzip="false" version="1.11" type="jar" dest="${lib.dir}" />
		 -->
		<dependency groupId="jline" artifactId="jline" version="2.12" dest="${lib.dir}" type="jar" unzip="false"/>
		<dependency groupId="org.eclipse.jgit" artifactId="org.eclipse.jgit" version="4.0.1.201506240215-r" dest="${lib.dir}" repoId="jgit-repository" unzip="false" type="jar">
			<exclusions>
				<!-- Lucee already includes these jars --> 
				<exclusion groupId="org.slf4j" artifactId="slf4j-api" />
				<exclusion groupId="org.apache.httpcomponents" artifactId="httpclient" />
			</exclusions>
		</dependency>
	    <dependency groupId="com.beust" artifactId="jcommander" version="1.47" dest="${lib.dir}" type="jar" unzip="false"/>
	    <dependency groupId="net.minidev" artifactId="json-smart-mini" version="1.0.8" unzip="false" type="jar" dest="${lib.dir}"/>
	    <dependency groupId="org.cfmlprojects" artifactId="runwar" version="${runwar.version}" dest="${lucee.lib.dir}" unzip="false" type="jar" />
	    <!-- engine libs -->
	  	<dependency groupId="org.lucee" artifactId="lucee" version="${lucee.version}" dest="${lucee.lib.dir}" unzip="false" type="jar">
			<exclusions>
				<exclusion groupId="org.lucee.lib" artifactId="railo-slf4j" />
			</exclusions>
		</dependency>
	    <dependency groupId="org.lucee" artifactId="lucee.optional" version="${lucee.version}" 
	      dest="${lucee.lib.dir}" unzip="false" type="pom" />
		  <move file="${lucee.lib.dir}/lucee-inst-${lucee.version}.jar" toFile="${lucee.lib.dir}/lucee-inst.jar"/>
		  <delete dir="${lucee.lib.dir}" includes="*.pom"/>
	    <mvn-repo id="java.repo" url="http://download.java.net/maven/2/" />
	    <dependency groupId="javax.mail" artifactId="mail" version="1.4.4" dest="${lucee.lib.dir}" repoId="java.repo" unzip="false" type="jar" />
   </target>

	<!-- Get launch4j -->
	<target name="getlaunch4j" description="Get an OS dependent launch4j into the build directory">
		<!-- do a check -->
		<antcontrib:if>
	        <available file="launch4j/launch4j.jar" />
	        <then><echo>Launch4j Binary found!</echo></then>
	        <else>
	            <echo>Launch4j not found, getting artifact from ${ortus.repoURL}</echo>
	            <!-- Determine OS type -->
				<antcontrib:if>
					<os family="windows" />
					<then><property name="launch4j.filename" value="launch4j-${launch4j.version}-win32.zip"/></then>
					<elseif>
						<os family="mac" />
						<then><property name="launch4j.filename" value="launch4j-${launch4j.version}-macosx.tgz"/></then>
					</elseif>
					<elseif>
						<os family="unix" />
						<then><property name="launch4j.filename" value="launch4j-${launch4j.version}-linux.tgz"/></then>
					</elseif>
				</antcontrib:if>
				<echo>Downloading ${launch4j.filename} from ${ortus.repoURL}...</echo>
				<get src="${ortus.repoURL}/launch4j/${launch4j.version}/${launch4j.filename}" 
					 dest="."
					 verbose="true" />
				<!-- Unzip according to OS -->
				<antcontrib:if>
					<os family="windows" />
					<then>
						<unzip src="${launch4j.filename}" dest="." overwrite="true"/>
					</then>
					<else>
						<untar src="${launch4j.filename}" dest="." compression="gzip"/>
					</else>
				</antcontrib:if>
				<!-- Removal -->
				<delete file="${launch4j.filename}" />
	        </else>
	    </antcontrib:if>
	    <!-- Add execution perms every time just in case -->
	    <chmod dir="./launch4j/bin/" perm="ugo+rx" includes="*"/>
	</target>
	
	<!-- Get Dependencies -->
	<target name="getDependencies" description="Get all the necessary dependencies for the cli build process." depends="getlaunch4j">
		<!-- Get Runwar -->
		<box-dependency groupID="cfmlprojects" 
 						artifactID="runwar" 
 						version="${runwar.version}"
 						extension="jar"
 						destination="${dependencies.dir}"/>
 		<copy file="${dependencies.dir}/runwar-${runwar.version}.jar" toDir="${lucee.lib.dir}" encoding="UTF-8" />
 		<!-- Get JLine directly to railo build dir -->
 		<box-dependency groupID="" 
 						artifactID="jline" 
 						version="${jline.version}"
 						extension="jar"
 						destination="${dependencies.dir}"/>
 		<copy file="${dependencies.dir}/jline-${jline.version}.jar" toDir="${railo.lib.dir}" encoding="UTF-8" />
 		<!-- Get Railo as a dependency -->
 		<box-dependency groupID="railo" 
 						artifactID="railo" 
 						classifiers="jars"
 						version="${railo.version}"
 						destination="${dependencies.dir}"/>
		<!-- Expand to railo lib for build process -->
		<unzip src="${dependencies.dir}/railo-jars-${railo.version}.zip" dest="${railo.lib.dir}" overwrite="true"/>
	</target>

	<!-- ********************************************************************************************-->
	<!--						CUSTOM MACROS    													 -->
	<!-- ********************************************************************************************-->
	
	<!-- Configure Lucee Web -->
	<macrodef name="configure-lucee-web">
		<attribute name="lucee-jar" default="${lucee.lib.dir}/lucee-jar-${lucee.version}.jar" />
		<attribute name="config-web" />
		<attribute name="config-server" />
		<attribute name="dump-cfc" />
		<sequential>
		  <dependency groupId="org.lucee" artifactId="lucee.config" version="${lucee.version}" dest="${temp.dir}/luceeconfigs" unzip="true" type="zip" />
		  <property name="extracted" value="${temp.dir}/luceeconfigs" />
		  <copy file="${extracted}/server.xml" tofile="@{config-server}" overwrite="true" />
		  <copy file="${extracted}/web.xml" tofile="@{config-web}" overwrite="true" />
		</sequential>
	</macrodef>
	
	<!-- Update Lucee Error Template -->
	<macrodef name="lucee-error-template">
		<attribute name="path" />
		<attribute name="type" default="500" />
		<attribute name="configfile" default="${lucee.config.file}" />
		<sequential>
			<echo>setting lucee template-@{type} to @{path}</echo>
			<antcontrib:var name="lucee.template.error.exists" unset="true" />
			<xmltask source="@{configfile}" dest="@{configfile}">
				<copy path="/*[1]/error/@status-code" attrValue="true" property="lucee.template.error.exists"/>
				<insert path="/*[1]" position="under" unless="lucee.template.error.exists"><![CDATA[<error status-code="true"/>]]></insert>
				<attr path="/*[1]/error" attr="template-@{type}" value="@{path}" />
			</xmltask>
		</sequential>
	</macrodef>	

	<!-- Macro to pack jars via java tool -->
	<macrodef name="packjars">
	    <attribute name="dir"/>
	    <attribute name="packdir"/>
		<attribute name="excludes" default=""/>
	    <sequential>
	    	<for param="file">
	    	  <path>
	    	    <fileset dir="@{dir}" includes="*.jar" excludes="@{excludes}"/>
	    	  </path>
	    	  <sequential>
	    	  	<var name="pack200.destdir" unset = "true"/> 
	    	  	<property name="pack200.destdir" location="@{packdir}"/> 
	    	  	<var name="pack200.destfile" unset = "true"/> 
                <basename property="pack200.destfile" file="@{file}" /> 
	    	  	<echo message="packing @{file}"/>
		        <exec executable="${java.home}/bin/pack200" resultproperty="pack.resultcode">
		            <arg value="${pack200.destdir}/${pack200.destfile}.pack.gz"/>
		            <arg value="@{file}"/>
		        </exec>
	    	  	<if>
	    	  		<equals arg1="${pack.resultcode}" arg2="0" />
	    	  		<else>
	    	  			<copy file="@{file}" todir="@{packdir}" verbose="false"/>
	    	  			<delete file="${pack200.destdir}/${pack200.destfile}.pack.gz" quiet="true" verbose="false"/>
	    	  		</else>
	    	  	</if>
	    	  	<var unset="true" name="pack.resultcode" />
	    	  </sequential>
	    	</for>
	    	<!-- we just copy any excluded jars without packing them -->
    	    <copy todir="@{packdir}">
    	      <fileset dir="@{dir}" includes="@{excludes}"/>
    	    </copy>
	     </sequential>
	</macrodef>

	<!-- ********************************************************************************************-->
	<!--						TEST TARGETS 														 -->
	<!-- ********************************************************************************************-->

	<target name="build.testwar" depends="cfdistro.build" description="creates test war">
		<!-- creates a war for testing in dist/, use 'box-cli runwar.start.fg' to run -->
		<dependency artifactId="testbox" groupId="org.coldbox" version="1.1.0" mapping="/testbox" />
		<!-- set mapping for MXUnit compat -->
		<mapping physical="@ext.mappings.dir@/org.coldbox/testbox/1.1.0/system/testing/compat" virtual="/mxunit"/>
		<!-- set mappings for sources, tests -->
		<mapping virtual="/commandbox" physical="@src.dir@/cfml" />
		<mapping virtual="/wirebox" physical="@src.dir@/cfml/system/wirebox" />
		<mapping virtual="/cfml" physical="@src.dir@/cfml" />
		<mapping virtual="/tests" physical="@src.dir@/../tests" />
	</target>

	<target name="test" description="starts test server, runs tests, then stops test server">
		<server-run>
			<testbox-rundirs basePath="${tests.dir}/cfml" componentPath="tests.cfml" outputdir="${dist.dir}/testresults/"  
			runner="http://${runwar.host}:${runwar.port}/tests/tboxrunner.cfm?"/>
		</server-run>
	</target>

	<target name="build.test" depends="build.testwar,test" description="build test war, run tests">
		<!-- mostly for automated builds- you really only need to build the testwar once -->
	</target>

	<target name="build.test.all" depends="build.cli.all, build.test">
	</target>

</project>
